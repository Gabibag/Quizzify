<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Play Drag Match!</title>
    <link rel="stylesheet" href="/styles/dragmatch.css" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Titan+One&display=swap");
    </style>
  </head>
  <body>
    <div id="endscreen">
      <div id="endcard">
        <h1 id="title">Match!</h1>
        <h2 id="endscreentext">
          You finished in <span id="time">0</span> seconds! &#10;&#13;
        </h2>
        <div id="endbuttons">
          <button
            id="leaderboard"
            onclick="window.location = '/sets/'+ setId+ '/dragmatch/leaderboard'"
          >
            Leaderboard
          </button>
          <button id="set" onclick="window.location = '/sets/' + setId">
            Back to Set
          </button>
          <button id="retry" onclick="location.reload()">Retry</button>
        </div>
      </div>
    </div>
    <div id="Start">
      <div id="midstart">
        <h1 class="heading">Match!</h1>
        <p id="description">Connect the terms with their definitions!</p>
        <p>Click anywhere to start</p>
      </div>
    </div>
    <div id="game">
      <h1 class="heading">Match!</h1>
      <div id="termcont">
        <li id="terms" class="itemlist"></li>
        <li id="definitions" class="itemlist"></li>
      </div>
    </div>
    <div id="timer">
      <span id="timerbar">20</span>
    </div>

    <script>
      document.addEventListener("click", function () {
        document.getElementById("Start").style.display = "none";
        BeginGame();
      });
      let setId = "<!--id-->";
      let name = `<!--name--> `;
      let description = `<!--desc-->`;
      let terms = `<!--terms-->`.split("");
      let defs = `<!--defs-->`.split("");
      let author = "<!--author-->";
      function vaildMatch(one, two) {
        if (one === two) {
          return false;
        }
        one = one.id;
        two = two.id;
        for (let i = 0; i < terms.length; i++) {
          if (
                  (terms[i] == one && defs[i] == two) ||
                  (terms[i] == two && defs[i] == one)
          ) {
            return true;
          }
        }
      }
      function shuffle(list) {
        for (let i = 0; i < list.length; i++) {
          let rand = Math.floor(Math.random() * list.length);
          let temp = list[i];
          list[i] = list[rand];
          list[rand] = temp;
        }
      }
      let stime = null;
      function BeginGame() {
        if (stime) {
          return;
        }
        stime = new Date().getTime();
        let randTermsleft = [...terms];
        let randTermsright = [...defs];
        shuffle(randTermsleft);
        shuffle(randTermsright);
        let tlist = document.getElementById("terms");
        let dlist = document.getElementById("definitions");
        for (let i = 0; i < randTermsleft.length; i++) {
          let li = document.createElement("li");
          li.addEventListener("click", clickTermOrDef);
          li.innerHTML = randTermsleft[i];
          li.id = randTermsleft[i];
          tlist.appendChild(li);
          li = document.createElement("li");
          li.addEventListener("click", clickTermOrDef);
          li.innerHTML = randTermsright[i];
          li.id = randTermsright[i];
          dlist.appendChild(li);
        }
      }


      function GameOver() {

        //check if terms and defs are all hidden
        let terms = document.getElementById("terms").children;
        let defs = document.getElementById("definitions").children;
        for (let i = 0; i < terms.length; i++) {
          console.log(terms[i].style.opacity);
          if (terms[i].style.opacity !== "0") {
            return false;
          }
        }
        for (let i = 0; i < defs.length; i++) {
          if (defs[i].style.opacity !== "0") {
            return false;
          }
        }
        return true;

      }

      let lastHit;
      function clickTermOrDef() {
        if (lastHit == null) {
          lastHit = this;
          this.classList.add("selected");
          return;
        }
        this.classList.add("selected");
        let s = this;
        let t = lastHit;

        if (vaildMatch(t, s)) {
          console.log("match");
          console.log(t.id);
          console.log(s.id);
          console.log(t);
          document.getElementById(t.id).style.transition = "1s ease-out"; //Could these have been done with animations?
          document.getElementById(s.id).style.transition = "1s ease-out"; //yes. Did they smoothly transition between
          document.getElementById(t.id).style.transform = "scale(1.2)";   //the two states? No.
          document.getElementById(s.id).style.transform = "scale(1.2)";
          document.getElementById(t.id).style.opacity = "0";
          document.getElementById(s.id).style.opacity = "0";
          setTimeout(() => {
            document.getElementById(t.id).display = "none";
            document.getElementById(s.id).display = "none";
            document.getElementById(s.id).pointerType = "default";
            document.getElementById(t.id).pointerType = "default";
            document.getElementById(t.id).removeEventListener("click", clickTermOrDef);
            document.getElementById(s.id).removeEventListener("click", clickTermOrDef);
            if (GameOver()) {
              //remove all elements in lists
              let terms = document.getElementById("terms").children;
              let defs = document.getElementById("definitions").children;
              for (let i = 0; i < terms.length; i++) {
                terms[i].remove();
              }
              for (let i = 0; i < defs.length; i++) {
                defs[i].remove();
              }

              clearInterval(timer);
              let time = new Date().getTime() - stime;
              document.getElementById("endscreen").style.display = "flex";
              document.getElementById("time").innerHTML = time / 1000;
              let score = Math.round(1000 * (1 / (0.01 * (time / 1000 + 3))));
              fetch("/api/submitscore/" + setId + "/dragmatch", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  score: score,
                }),
              });
            }
          }, 1000);

        } else {
          // let t = this;
          // let s = lastHit;
          document.getElementById(s.id).classList.remove("selected");
          document.getElementById(t.id).classList.remove("selected");
          document.getElementById(s.id).style.animation = "shakeError 0.7s forwards";
          document.getElementById(t.id).style.animation = "shakeError 0.7s forwards";
          setTimeout(function () {
            document.getElementById(t.id).style.animation = "";
            s.style.animation = "";
          }, 700);

        }


        lastHit = null;

      }

      //   display a timer in the top right
      let timer = setInterval(function () {
        let time = new Date().getTime() - stime;
        document.getElementById("timerbar").innerHTML = "Score: " + Math.round(1000 * (1 / (0.01 * (time / 1000 + 3))));
        /*if (time > 20000) {
          document.getElementById("endscreen").style.display = "flex";
          document.getElementById("time").innerHTML = "20";
          let score = 0;
          fetch("/api/submitscore/" + setId + "/dragmatch", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              score: score,
            }),
          });
        }*/
      }, 100);

    </script>
  </body>
</html>
