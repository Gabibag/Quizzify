<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Play Drag Match!</title>
    <link rel="stylesheet" href="/styles/dragmatch.css" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Titan+One&display=swap");
    </style>
  </head>
  <body>
    <div id="endscreen">
      <div id="endcard">
        <h1 id="title">Match!</h1>
        <h2 id="endscreentext">
          You finished in <span id="time">0</span> seconds! &#10;&#13;
        </h2>
        <div id="endbuttons">
          <button
            id="leaderboard"
            onclick="window.location = '/sets/'+ setId+ '/dragmatch/leaderboard'"
          >
            Leaderboard
          </button>
          <button id="set" onclick="window.location = '/sets/' + setId">
            Back to Set
          </button>
          <button id="retry" onclick="location.reload()">Retry</button>
        </div>
      </div>
    </div>
    <div id="Start">
      <div id="midstart">
        <h1 id="title">Match!</h1>
        <p id="description">Connect the terms with their definitions!</p>
        <p>Click anywhere to start</p>
      </div>
    </div>
    <div id="game">
      <h1 id="title">Match!</h1>
      <div id="termcont">
        <li id="terms" class="itemlist"></li>
        <li id="definitions" class="itemlist"></li>
      </div>
    </div>

    <script>
      let v = document.addEventListener("click", function () {
        document.getElementById("Start").style.display = "none";
        BeginGame();
      });
      let setId = "<!--id-->";
      let name = `<!--name--> `;
      let description = `<!--desc-->`;
      let terms = `<!--terms-->`.split("");
      let defs = `<!--defs-->`.split("");
      let author = "<!--author-->";
      function vaildMatch(one, two) {
        for (let i = 0; i < terms.length; i++) {
          if (
            (terms[i] == one && defs[i] == two) ||
            (terms[i] == two && defs[i] == one)
          ) {
            return true;
          }
        }
      }
      function shuffle(list) {
        for (let i = 0; i < list.length; i++) {
          let rand = Math.floor(Math.random() * list.length);
          let temp = list[i];
          list[i] = list[rand];
          list[rand] = temp;
        }
      }
      let stime = null;
      function BeginGame() {
        if (stime) {
          return;
        }
        stime = new Date().getTime();
        let randTermsleft = [...terms];
        let randTermsright = [...defs];
        shuffle(randTermsleft);
        shuffle(randTermsright);
        let tlist = document.getElementById("terms");
        let dlist = document.getElementById("definitions");
        for (let i = 0; i < randTermsleft.length; i++) {
          let li = document.createElement("li");
          li.addEventListener("click", clickTermOrDef);
          li.innerHTML = randTermsleft[i];
          li.id = randTermsleft[i];
          tlist.appendChild(li);
          li = document.createElement("li");
          li.addEventListener("click", clickTermOrDef);
          li.innerHTML = randTermsright[i];
          li.id = randTermsright[i];
          dlist.appendChild(li);
        }
      }
      function GameOver() {
        console.log(document.getElementById("terms").children);
        return (
          document.getElementById("terms").children.length == 0 &&
          document.getElementById("definitions").children.length == 0
        );
      }

      let lastHit = null;

      function clickTermOrDef() {
        if (lastHit == null) {
          lastHit = this;
          this.classList.add("selected");
        } else {
          // lastHit.classList.remove("selected");
          if (vaildMatch(lastHit.id, this.id)) {
            let s = this.id;
            let t = lastHit.id;
            // document.getElementById(t).style.scale = "0";
            document.getElementById(s).style.scale = "0";
            setTimeout(function () {
              document.getElementById(t).remove();
              document.getElementById(s).remove();
              if (GameOver()) {
                let time = new Date().getTime() - stime;
                document.getElementById("endscreen").style.display = "flex";
                document.getElementById("time").innerHTML = time / 1000;
                let score = Math.round(1000 * (1 / (0.01 * (time / 1000 + 3))));
                fetch("/api/submitscore/" + setId + "/dragmatch", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    score: score,
                  }),
                });
              }
            }, 700);
          }
          lastHit = null;
        }
      }
    </script>
  </body>
</html>
